<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Importar Excel ‚Üí Gerar Gr√°ficos ‚Üí Exportar PDF</title>

    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>

    <style>
      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        padding: 20px;
        background: #f6f6f9;
        color: #333;
      }
      h1 {
        text-align: center;
        color: #2563eb;
      }

      .card {
        background: white;
        padding: 20px;
        margin-bottom: 20px;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }

      /* Estilo da √°rea de exibi√ß√£o na tela */
      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(500px, 1fr));
        gap: 25px;
      }
      .chart-wrapper {
        position: relative;
        /* AJUSTE PARA 300PX: Reduzido de 400px para 300px (para gr√°ficos individuais) */
        height: 300px;
        width: 100%;
      }
      .grid h4 {
        text-align: center;
        margin-bottom: 10px;
        color: #333;
        height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0 10px;
      }

      button {
        padding: 12px 20px;
        border: none;
        background: #2563eb;
        color: white;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        transition: background 0.3s;
      }
      button:hover {
        background: #1d4ed8;
      }
      button.secondary {
        background: #64748b;
        color: white;
      }
      button.secondary:hover {
        background: #475569;
      }

      input[type='file'] {
        padding: 10px;
        border: 1px dashed #ccc;
        width: 100%;
        box-sizing: border-box;
      }
      .hidden {
        display: none;
      }

      /* Estilos GERAIS para Coment√°rios e Pontos de Aten√ß√£o (na tela) */
      .commentary {
        white-space: pre-wrap;
        padding: 15px;
        border: 1px solid #2563eb; /* ALTERADO: Borda azul (mesma cor da borda esquerda) */
        border-left: 5px solid #2563eb;
        background-color: #f9f9ff;
        border-radius: 4px;
        margin-top: 20px;
        font-size: 13px;
      }
      .attention-point {
        padding: 15px;
        border: 1px solid #f97316;
        border-left: 5px solid #f97316;
        background-color: #fff7ed;
        border-radius: 4px;
        margin-top: 15px;
        font-weight: bold;
        font-size: 13px;
      }

      /* Estilos GERAIS para Plano de A√ß√£o (na tela) */
      .action-plan-box {
        padding: 15px;
        border: 1px solid #10b981; /* Verde esmeralda */
        border-left: 5px solid #10b981;
        background-color: #ecfdf5; /* Fundo verde muito claro */
        border-radius: 4px;
        margin-top: 15px;
        font-size: 13px;
      }

      /* Estilos GERAIS da Tabela de Dados (na tela) */
      .chart-data-table {
        width: 100%;
        margin-top: 15px;
        border-collapse: collapse;
        font-size: 12px;
      }
      .chart-data-table th,
      .chart-data-table td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: center;
      }
      .chart-data-table th {
        background-color: #f2f2f2;
      }

      /* === Destaque para Textos em Negrito (b) === */
      .commentary b,
      .attention-point b {
        font-weight: 900;
        color: #1a1a1a;
      }

      /* === Estilo para o T√≠tulo da Dimens√£o (Tela) === */
      .dimension-header {
        background: #eef2ff;
        color: #1e40af;
        padding: 20px;
        margin: 30px 0 10px 0;
        border-radius: 8px;
        border: 1px solid #c7d2fe;
        font-size: 16px;
        font-weight: bold;
        white-space: pre-wrap;
        line-height: 1.4;
      }
      .dimension-header span {
        display: block;
        font-weight: normal;
        color: #4b5563;
        font-size: 13px;
        margin-top: 5px;
      }

      /* === ESTILOS ESPEC√çFICOS PARA O PDF (REDU√á√ÉO DE FONTE) === */
      #pdfReportContainer {
        position: absolute;
        left: -9999px;
        top: -9999px;
        /* Largura padr√£o, ajustada dinamicamente pelo JS para Paisagem/Retrato */
        width: 880px; /* VALOR AJUSTADO PARA SERVIR DE BASE PARA LANDSCAPE */
        padding: 0;
        background: white;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        box-sizing: border-box;
        /* Fonte Globalmente aumentada */
        font-size: 12px;
      }
      .pdf-report-item {
        padding: 10px;
        margin-bottom: 0;
      }
      .pdf-report-item h2 {
        /* Aumento: 13px -> 14px */
        font-size: 14px;
        margin-bottom: 15px;
        text-align: center;
        color: #2563eb;
      }

      /* Redu√ß√£o de Fonte para Coment√°rio/Aten√ß√£o (PDF) */
      #pdfReportContainer .commentary,
      #pdfReportContainer .attention-point,
      #pdfReportContainer .action-plan-box {
        padding: 10px;
        /* Aumento: 10px -> 11px */
        font-size: 11px;
        margin-top: 10px;
        margin-bottom: 10px;
      }

      /* Redu√ß√£o de Fonte para Tabela de Dados (PDF) */
      #pdfReportContainer .chart-data-table {
        /* Aumento: 10px -> 11px */
        font-size: 11px;
      }
      #pdfReportContainer .chart-data-table th,
      #pdfReportContainer .chart-data-table td {
        padding: 5px; /* Redu√ß√£o do padding da tabela */
      }

      /* Estilo para o T√≠tulo da Dimens√£o (PDF) */
      #pdfReportContainer .dimension-header {
        padding: 15px;
        margin: 15px 0 10px 0;
        /* Aumento: 13px -> 14px */
        font-size: 14px;
      }
      #pdfReportContainer .dimension-header span {
        /* Aumento: 10px -> 11px */
        font-size: 11px;
      }
      /* =========================================
         ESTILOS ESPEC√çFICOS PARA O DASHBOARD FINAL (PDF/SCREEN CAPTURE)
         ========================================= */
      #dashboard-final-container {
        /* Garante que o container ocupe a largura da card na tela */
        width: 100%;
        padding: 10px;
        background: #fff;
        box-sizing: border-box;
        font-family: Arial, sans-serif;
        font-size: 11px; /* Fonte reduzida para caber na tela */
      }
      .dash-header {
        text-align: center;
        margin-bottom: 15px;
        border-bottom: 1px solid #ccc;
        padding-bottom: 5px;
      }
      .dash-header h2 {
        margin: 0;
        color: #333;
        font-size: 22px; /* NOVO AJUSTE: Aumentado de 20px para 22px */
        text-transform: uppercase;
      }
      .dash-sub {
        font-size: 16px; /* NOVO AJUSTE: Aumentado de 14px para 16px */
        color: #666;
        margin-top: 5px;
      }

      /* Layout da Linha (Row) */
      .dash-row {
        display: flex;
        border: 1px solid #999;
        margin-bottom: 10px;
        /* AJUSTE CHAVE: MANTIDO em 550px para dar altura */
        height: 550px;
      }

      /* Coluna 1: Quantidade */
      .dash-col-qty {
        width: 15%;
        border-right: 1px solid #999;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        background-color: #f4f4f4;
        padding: 5px;
      }
      .dash-qty-label {
        font-size: 14px; /* NOVO AJUSTE: Aumentado de 12 para 14px */
        font-weight: bold;
        text-align: center;
        margin-bottom: 5px;
        color: #333;
        line-height: 1.2;
      }
      .dash-qty-val {
        font-size: 50px; /* NOVO AJUSTE: Aumentado de 40px para 50px */
        font-weight: bold;
        color: #000;
      }

      /* Coluna 2: Pizza - MANTIDO */
      .dash-col-pie {
        width: 32%;
        border-right: 1px solid #999;
        padding: 5px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
      }
      .dash-chart-title {
        font-size: 15px; /* NOVO AJUSTE: Aumentado de 13px para 15px */
        font-weight: bold;
        margin-bottom: 5px;
        color: #444;
        text-align: center;
        width: 100%;
      }
      /* ATEN√á√ÉO: ALTERA√á√ÉO AQUI para ajustar o tamanho do gr√°fico de pizza */
      .dash-col-pie > div {
        display: flex;
        justify-content: center;
        align-items: center;
        /* MANTIDO em 98% */
        height: 98%;
        width: 100%;
        position: relative;
      }

      /* Coluna 3: Barras - MANTIDO */
      .dash-col-bar {
        width: 53%;
        padding: 5px;
        display: flex;
        flex-direction: column;
        justify-content: center;
      }
    </style>
  </head>
  <body>
    <h1>Relat√≥rio Autom√°tico: Job Stress Scale</h1>

    <div class="card">
      <label style="font-weight: bold; display: block; margin-bottom: 10px"
        >1. Selecione o arquivo Excel:</label
      >
      <input id="fileInput" type="file" accept=".xlsx,.xls" />
    </div>

    <div class="card hidden" id="controls">
      <label style="font-weight: bold; display: block; margin-bottom: 10px"
        >2. A√ß√µes:</label
      >
      <div style="display: flex; gap: 10px">
        <button id="btnGerar">Gerar Gr√°ficos na Tela</button>
        <button id="btnPDF" class="secondary">Exportar Relat√≥rio PDF</button>
      </div>
    </div>

    <div class="card hidden" id="graficosCard">
      <h3>Pr√©-visualiza√ß√£o dos Gr√°ficos Individuais</h3>
      <div id="commentaryDiv" class="commentary hidden"></div>
      <div id="charts" class="grid"></div>
    </div>

    <div class="card hidden" id="dashboard-final-card">
      <h3>Dashboard de Resumo Final</h3>
      <div id="dashboard-final-container">
        <div class="dash-header">
          <p class="dash-sub">
            DASHBOARD RESUMO: DIMENS√ïES DEMANDA, CONTROLE E APOIO SOCIAL
          </p>
          <h2>DISTRIBUI√á√ÉO RESPOSTAS QUESTION√ÅRIO KARASEK</h2>
        </div>
        <div class="dash-row">
          <div class="dash-col-qty">
            <span class="dash-qty-label">TOTAL RESPOSTAS DEMANDA</span>
            <span class="dash-qty-val" id="final-qty-demanda">0</span>
          </div>
          <div class="dash-col-pie">
            <span class="dash-chart-title">% Total Demanda</span>
            <div><canvas id="final-pie-demanda"></canvas></div>
          </div>
          <div class="dash-col-bar">
            <div style="flex: 1; width: 100%; position: relative">
              <canvas id="final-bar-demanda"></canvas>
            </div>
          </div>
        </div>
        <div class="dash-row">
          <div class="dash-col-qty">
            <span class="dash-qty-label">TOTAL RESPOSTAS CONTROLE</span>
            <span class="dash-qty-val" id="final-qty-controle">0</span>
          </div>
          <div class="dash-col-pie">
            <span class="dash-chart-title">% Total Controle</span>
            <div><canvas id="final-pie-controle"></canvas></div>
          </div>
          <div class="dash-col-bar">
            <div style="flex: 1; width: 100%; position: relative">
              <canvas id="final-bar-controle"></canvas>
            </div>
          </div>
        </div>
        <div class="dash-row">
          <div class="dash-col-qty">
            <span class="dash-qty-label">TOTAL RESPOSTAS APOIO SOCIAL</span>
            <span class="dash-qty-val" id="final-qty-apoio">0</span>
          </div>
          <div class="dash-col-pie">
            <span class="dash-chart-title">% Total Apoio Social</span>
            <div><canvas id="final-pie-apoio"></canvas></div>
          </div>
          <div class="dash-col-bar">
            <div style="flex: 1; width: 100%; position: relative">
              <canvas id="final-bar-apoio"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div id="pdfReportContainer"></div>

    <script>
      // Desestrutura√ß√µes Globais
      const { ChartDataLabels } = window
      // Se Chart.js n√£o carregar, esta linha falha.
      if (ChartDataLabels) Chart.register(ChartDataLabels)

      const { jsPDF } = window.jspdf

      // ======================================================================
      // === CONSTANTES GLOBAIS ===
      // ======================================================================

      // Modificado para atender a solicita√ß√£o do usu√°rio: primeira letra min√∫scula, cor AZUL no render, e remo√ß√£o dos dois pontos.
      const NEW_COMMENTARY_TITLE =
        'Coment√°rios gerais - An√°lise do Ergonomista Pesquisador sobre os dados coletados'
      // Novo t√≠tulo para Ponto de Aten√ß√£o com cor LARANJA no render, e remo√ß√£o dos dois pontos.
      const ATTENTION_POINT_TITLE = 'Ponto de aten√ß√£o'
      // Novo t√≠tulo para Plano de A√ß√£o com primeira letra mai√∫scula e cor VERDE no render.
      const ACTION_PLAN_TITLE = 'Plano de a√ß√£o proposto'

      // CORES PARA O DASHBOARD KARASEK (Atualizadas para profissional)
      // Ordem: 1. Azul Escuro, 2. Azul M√©dio, 3. Cinza Neutro, 4. Cinza Claro
      const COLORS_DASHBOARD = ['#1e40af', '#3b82f6', '#9ca3af', '#d1d5db'] // [Mais Favor√°vel -> Menos Favor√°vel/Risco]

      // Valores num√©ricos para c√°lculo do ponto de corte (Karasek) - MANTIDOS, mas n√£o usados no dashboard
      const SCORE_MAP = {
        // Demanda e Controle
        'Nunca ou quase nunca': 1,
        Raramente: 2,
        '√Äs vezes': 3,
        Frequentemente: 4,
        // Apoio Social (Inverso para Apoio)
        'Discordo totalmente': 1,
        'Discordo mais que concordo': 2,
        'Concordo mais que discordo': 3,
        'Concordo totalmente': 4
      }

      // ======================================================================
      // === CONSTANTE NOVO PLANO DE A√á√ÉO ===
      // ======================================================================
      const ACTION_PLAN_TEXTS = {
        'Com que frequ√™ncia voc√™ tem que fazer suas tarefas de trabalho com muita rapidez?':
          'D1 ‚Äì Identificar os fatores organizacionais que influenciam a cad√™ncia e velocidade na realiza√ß√£o das tarefas de trabalho.',
        'Com que frequ√™ncia voc√™ tem que trabalhar intensamente (isto √©, produzir muito em pouco tempo)?':
          'D2 ‚Äì Identificar os fatores organizacionais que influenciam a intensidade de produ√ß√£o na realiza√ß√£o das tarefas de trabalho.',
        'Seu trabalho exige demais de voc√™?':
          'D3 ‚Äì Avaliar o n√≠vel de exig√™ncia requerida para realiza√ß√£o das tarefas de trabalho.',
        'Voc√™ tem tempo suficiente para cumprir todas as tarefas de seu trabalho?':
          'D4 ‚Äì Avaliar o conte√∫do do tempo necess√°rio para realiza√ß√£o das tarefas de trabalho.',
        'O seu trabalho costuma apresentar exig√™ncias contradit√≥rias ou discordantes?':
          'D5 ‚Äì Identificar as exig√™ncias contradit√≥rias ou discordantes presentes nas tarefas de trabalho.',
        'Voc√™ tem possibilidade de aprender coisas novas em seu trabalho?':
          'C1 ‚Äì Revisar sistematicamente as possibilidades de novos aprendizados na realiza√ß√£o das tarefas de trabalho.',
        'Seu trabalho exige muita habilidade ou conhecimentos especializados?':
          'C2 ‚Äì Avaliar sistematicamente os n√≠veis de exig√™ncia quanto as habilidades ou conhecimentos especializados requeridos na realiza√ß√£o das tarefas.',
        'Seu trabalho exige que voc√™ tome iniciativas?':
          'C3 ‚Äì Identificar a presen√ßa da tomada de iniciativas necess√°rias a realiza√ß√£o das tarefas de trabalho.',
        'No seu trabalho, voc√™ tem que repetir muitas vezes as mesmas tarefas?':
          'C4 ‚Äì Avaliar o n√≠vel de repetitividade das mesmas tarefas realizadas.',
        'Voc√™ pode escolher "Como" fazer o seu trabalho?':
          'C5 ‚Äì Avaliar o n√≠vel da percep√ß√£o de autonomia dos empregados no como podem escolher como fazer no seu trabalho.',
        'Voc√™ pode escolher "O QUE" fazer no seu trabalho?':
          'C6 ‚Äì Avaliar o n√≠vel de rigidez na possibilidade do que podem fazer nas tarefas do seu trabalho.',
        'Existe um ambiente calmo e agrad√°vel onde trabalho.':
          'A1 ‚Äì Avaliar sistematicamente a percep√ß√£o de calma e agrad√°vel presente no seu ambiente de trabalho.',
        'No trabalho, nos relacionamos bem uns com os outros.':
          'A2 - Avaliar sistematicamente a percep√ß√£o dos empregados quanto a qualidade dos relacionamentos no ambiente de trabalho.',
        'Eu posso contar com o apoio dos meus colegas de trabalho.':
          'A3 ‚Äì Incentivar sistematicamente apoio entre colegas de trabalho.',
        'Se eu n√£o estiver num bom dia, meus colegas compreendem.':
          'A4 ‚Äì Incentivar sistematicamente a compreens√£o entre os colegas de trabalho em dias ruins.',
        'No trabalho, eu me relaciono bem com meus chefes.':
          'A5 - Incentivar sistematicamente o bom relacionamento entre l√≠deres e liderados.',
        'Eu gosto de trabalhar com meus colegas.':
          'A6 ‚Äì Avaliar sistematicamente o clima de trabalho entre colegas no ambiente de trabalho.'
      }

      // Mapeamento de Colunas (usaremos a ID para obter o score)
      const JSS_COLUMNS_RAW = [
        // --- DEMANDA (D1-D5) ---
        {
          id: 'Com que frequ√™ncia voc√™ tem que fazer suas tarefas de trabalho com muita rapidez?',
          category: 'Demanda',
          reverse: false,
          header:
            'D1: Com que frequ√™ncia voc√™ tem que fazer suas tarefas de trabalho com muita rapidez?'
        },
        {
          id: 'Com que frequ√™ncia voc√™ tem que trabalhar intensamente (isto √©, produzir muito em pouco tempo)?',
          category: 'Demanda',
          reverse: false,
          header:
            'D2: Com que frequ√™ncia voc√™ tem que trabalhar intensamente (isto √©, produzir muito em pouco tempo)?'
        },
        {
          id: 'Seu trabalho exige demais de voc√™?',
          category: 'Demanda',
          reverse: false,
          header: 'D3: Seu trabalho exige demais de voc√™?'
        },
        {
          id: 'Voc√™ tem tempo suficiente para cumprir todas as tarefas de seu trabalho?',
          category: 'Demanda',
          reverse: true,
          header:
            'D4: Voc√™ tem tempo suficiente para cumprir todas as tarefas de seu trabalho?'
        },
        {
          id: 'O seu trabalho costuma apresentar exig√™ncias contradit√≥rias ou discordantes?',
          category: 'Demanda',
          reverse: false,
          header:
            'D5: O seu trabalho costuma apresentar exig√™ncias contradit√≥rias ou discordantes?'
        },

        // --- CONTROLE (C1-C6) ---
        {
          id: 'Voc√™ tem possibilidade de aprender coisas novas em seu trabalho?',
          category: 'Controle',
          reverse: false,
          header:
            'C1: Voc√™ tem possibilidade de aprender coisas novas em seu trabalho?'
        },
        {
          id: 'Seu trabalho exige muita habilidade ou conhecimentos especializados?',
          category: 'Controle',
          reverse: false,
          header:
            'C2: Seu trabalho exige muita habilidade ou conhecimentos especializados?'
        },
        {
          id: 'Seu trabalho exige que voc√™ tome iniciativas?',
          category: 'Controle',
          reverse: false,
          header: 'C3: Seu trabalho exige que voc√™ tome iniciativas?'
        },
        {
          id: 'No seu trabalho, voc√™ tem que repetir muitas vezes as mesmas tarefas?',
          category: 'Controle',
          reverse: true,
          header:
            'C4: No seu trabalho, voc√™ tem que repetir muitas vezes as mesmas tarefas?'
        },
        {
          id: 'Voc√™ pode escolher "Como" fazer o seu trabalho?',
          category: 'Controle',
          reverse: false,
          header: 'C5: Voc√™ pode escolher "Como" fazer o seu trabalho?'
        },
        {
          id: 'Voc√™ pode escolher "O QUE" fazer no seu trabalho?',
          category: 'Controle',
          reverse: false,
          header: 'C6: Voc√™ pode escolher "O QUE" fazer no seu trabalho?'
        },

        // --- APOIO SOCIAL (A1-A6) ---
        {
          id: 'Existe um ambiente calmo e agrad√°vel onde trabalho.',
          category: 'Apoio Social',
          reverse: false,
          header: 'A1: Existe um ambiente calmo e agrad√°vel onde trabalho.'
        },
        {
          id: 'No trabalho, nos relacionamos bem uns com os outros.',
          category: 'Apoio Social',
          reverse: false,
          header: 'A2: No trabalho, nos relacionamos bem uns com os outros.'
        },
        {
          id: 'Eu posso contar com o apoio dos meus colegas de trabalho.',
          category: 'Apoio Social',
          reverse: false,
          header:
            'A3: Eu posso contar com o apoio dos meus colegas de trabalho.'
        },
        {
          id: 'Se eu n√£o estiver num bom dia, meus colegas compreendem.',
          category: 'Apoio Social',
          reverse: false,
          header: 'A4: Se eu n√£o estiver num bom dia, meus colegas compreendem.'
        },
        {
          id: 'No trabalho, eu me relaciono bem com meus chefes.',
          category: 'Apoio Social',
          reverse: false,
          header: 'A5: No trabalho, eu me relaciono bem com meus chefes.'
        },
        {
          id: 'Eu gosto de trabalhar com meus colegas.',
          category: 'Apoio Social',
          reverse: false,
          header: 'A6: Eu gosto de trabalhar com meus colegas.'
        }
      ]

      const DIMENSION_TITLES = {
        Demanda: `DIMENS√ÉO DEMANDA - D1 a D5.`,
        Controle: `DIMENS√ÉO CONTROLE - C1 a C6`,
        'Apoio Social': `DIMENS√ÉO APOIO SOCIAL - A1 a A6`
      }

      const DIMENSION_DESCRIPTIONS = {
        Demanda: `(demanda quantitativa - Tempo e velocidade na realiza√ß√£o do trabalho, demanda qualitativa - conflito entre demandas contradit√≥rias).`,
        Controle: `(possibilidade de utilizar habilidades intelectuais para a realiza√ß√£o do trabalho, com autoridade para tomar decis√µes sobre a forma de realiz√°-lo).`,
        'Apoio Social': `(n√≠veis de intera√ß√£o social existentes no trabalho, tanto com os colegas quanto com as chefias).`
      }

      let excelData = []
      let fullHeaders = []
      let chartObjects = []
      let detailedCommentaries = {}
      let companyName = 'Nome da Empresa N√£o Identificado'
      let finalCharts = [] // Gr√°ficos do Dashboard Final

      // üìå R√ìTULOS PADRONIZADOS (Manuten√ß√£o da ordem)
      const LABELS_DEMANDA_CONTROLE = [
        'Nunca ou quase nunca',
        'Raramente',
        '√Äs vezes',
        'Frequentemente'
      ]

      const LABELS_APOIO_SOCIAL = [
        'Discordo totalmente',
        'Discordo mais que concordo',
        'Concordo mais que discordo',
        'Concordo totalmente'
      ]

      // üìå Mapeamento de Colunas JSS (detalhado para gr√°ficos)
      const JSS_COLUMNS = JSS_COLUMNS_RAW.map((col) => {
        let riskLabels, favorable, unfavorable, labels
        if (
          col.category === 'Demanda' ||
          col.id.includes('repetir muitas vezes')
        ) {
          labels = LABELS_DEMANDA_CONTROLE
          riskLabels = ['Frequentemente', '√Äs vezes']
          favorable = ['Nunca ou quase nunca', 'Raramente']
          unfavorable = col.reverse ? favorable : riskLabels
          favorable = col.reverse ? riskLabels : favorable
        } else if (col.category === 'Controle') {
          labels = LABELS_DEMANDA_CONTROLE
          riskLabels = ['Raramente', 'Nunca ou quase nunca']
          favorable = ['Frequentemente', '√Äs vezes']
          unfavorable = col.reverse ? favorable : riskLabels
          favorable = col.reverse ? riskLabels : favorable
        } else if (col.category === 'Apoio Social') {
          labels = LABELS_APOIO_SOCIAL
          riskLabels = ['Discordo mais que concordo', 'Discordo totalmente']
          favorable = ['Concordo totalmente', 'Concordo mais que discordo']
          unfavorable = col.reverse ? favorable : riskLabels
          favorable = col.reverse ? riskLabels : favorable
        }
        return {
          ...col,
          labels,
          riskLabels,
          favorable,
          unfavorable,
          actionPlanText: ACTION_PLAN_TEXTS[col.id] || ''
        }
      })

      // ======================================================================
      // === FUN√á√ïES UTILIT√ÅRIAS ===
      // ======================================================================

      document
        .getElementById('fileInput')
        .addEventListener('change', async (e) => {
          const file = e.target.files[0]
          if (!file) return

          const ext = file.name.split('.').pop().toLowerCase()
          if (!['xls', 'xlsx'].includes(ext)) {
            alert('Formato inv√°lido. Selecione um arquivo .xls ou .xlsx.')
            return
          }

          try {
            const data = await file.arrayBuffer()
            const workbook = XLSX.read(data, { type: 'array' })
            const firstSheetName = workbook.SheetNames[0]
            const sheet = workbook.Sheets[firstSheetName]

            let rawData = XLSX.utils.sheet_to_json(sheet, {
              header: 1,
              defval: ''
            })

            if (rawData.length < 5) {
              alert(
                'A planilha n√£o possui dados suficientes (esperado iniciar na linha 5).'
              )
              return
            }

            // Captura do Nome da Empresa na linha 6 (√≠ndice 5), coluna B (√≠ndice 1)
            const companyNameRow = rawData[5]
            // --- IN√çCIO DA CORRE√á√ÉO ---
            companyName =
              String(companyNameRow[1]).trim() ||
              'Nome da Empresa N√£o Identificado'
            // --- FIM DA CORRE√á√ÉO ---

            const headers = rawData[4]

            const headersMap = {}
            for (let i = 11; i <= 27; i++) {
              const headerName = String(headers[i]).trim()
              if (headerName) {
                let mappedColumn = JSS_COLUMNS.find(
                  (col) => col.id.trim() === headerName.trim()
                )

                if (mappedColumn) {
                  headersMap[mappedColumn.id] = i
                } else {
                  console.warn(
                    `Cabe√ßalho n√£o mapeado (verifique a grafia): ${headerName}`
                  )
                }
              }
            }

            excelData = rawData
              .slice(5)
              .map((row) => {
                const obj = {}
                JSS_COLUMNS.forEach((col) => {
                  const colIndex = headersMap[col.id]
                  if (colIndex !== undefined) {
                    obj[col.id] =
                      row[colIndex] !== undefined ? row[colIndex] : ''
                  }
                })
                return obj
              })
              .filter((obj) => Object.keys(obj).length > 0)

            fullHeaders = JSS_COLUMNS.map((col) => col.id)

            document.getElementById('controls').classList.remove('hidden')
            document.getElementById('graficosCard').classList.add('hidden')
          } catch (err) {
            console.error(err)
            alert('Erro ao ler o arquivo Excel.')
          }
        })

      function contar(coluna) {
        const freq = {}
        coluna.forEach((v) => {
          const t = String(v).trim()
          if (!t) return
          if (!freq[t]) freq[t] = 0
          freq[t]++
        })
        return freq
      }

      function calcularPorcentagem(numerador, denominador, casasDecimais = 0) {
        if (denominador === 0 || Number(numerador) === 0) return '0.0'

        const resultado = (Number(numerador) / Number(denominador)) * 100
        return resultado.toFixed(casasDecimais)
      }

      function gerarComentarioGeralDetalhado(data) {
        const comentariosMapeados = {}

        JSS_COLUMNS.forEach((colConfig, index) => {
          const colId = colConfig.id
          const questionTitle =
            colConfig.header.split(/^[A-Z]\d+:\s/)[1] || colConfig.header

          const valores = data.map((r) => r[colId])
          const freq = contar(valores)
          const dataValues = colConfig.labels.map((k) => freq[k] || 0)
          const totalRespostasValidas = dataValues.reduce((a, b) => a + b, 0)

          if (totalRespostasValidas === 0) {
            comentariosMapeados[colId] = ''
            return
          }

          let comentario = `Internal Title - Quest√£o ${index + 1} (${
            colConfig.category
          }):\n`

          if (
            colConfig.category === 'Demanda' ||
            colConfig.category === 'Controle'
          ) {
            const countAsVezes = freq['√Äs vezes'] || 0
            const percAsVezes = calcularPorcentagem(
              countAsVezes,
              totalRespostasValidas,
              1
            )
            comentario += `**(${percAsVezes}%) dos empregados** consideram **${questionTitle}** - √Äs vezes;\n`

            const countFreq = freq['Frequentemente'] || 0
            const percFreq = calcularPorcentagem(
              countFreq,
              totalRespostasValidas,
              1
            )
            comentario += `**(${percFreq}%) dos empregados** consideram **${questionTitle}** - Frequentemente;\n`

            const countNuncaRaramente =
              (freq['Nunca ou quase nunca'] || 0) + (freq['Raramente'] || 0)
            const percNuncaRaramente = calcularPorcentagem(
              countNuncaRaramente,
              totalRespostasValidas,
              1
            )
            comentario += `**(${percNuncaRaramente}%) dos empregados** consideram **${questionTitle}** - Nunca ou quase nunca/Raramente;`
          } else if (colConfig.category === 'Apoio Social') {
            const countConcMais = freq['Concordo mais que discordo'] || 0
            const percConcMais = calcularPorcentagem(
              countConcMais,
              totalRespostasValidas,
              1
            )
            comentario += `**(${percConcMais}%) dos empregados** consideram **${questionTitle}** - Concordo mais que discordo;\n`

            const countConcTot = freq['Concordo totalmente'] || 0
            const percConcTot = calcularPorcentagem(
              countConcTot,
              totalRespostasValidas,
              1
            )
            comentario += `**(${percConcTot}%) dos empregados** consideram **${questionTitle}** - Concordo totalmente;\n`

            const countDiscordo =
              (freq['Discordo mais que concordo'] || 0) +
              (freq['Discordo totalmente'] || 0)
            const percDiscordo = calcularPorcentagem(
              countDiscordo,
              totalRespostasValidas,
              1
            )
            comentario += `**(${percDiscordo}%) dos empregados** consideram **${questionTitle}** - Discordo mais que concordo/Discordo totalmente;`
          }

          comentariosMapeados[colId] = comentario
        })

        return { commentary: comentariosMapeados, attention: '' }
      }

      function gerarPontoDeAtencao(colConfig, freq, totalRespostasValidas) {
        if (totalRespostasValidas === 0) return ''

        const questionTitle =
          colConfig.header.split(/^[A-Z]\d+:\s/)[1] || colConfig.header

        const riscoLabels = colConfig.unfavorable
        const atenuacaoLabels = colConfig.favorable

        const countRisco = riscoLabels.reduce(
          (sum, label) => sum + (freq[label] || 0),
          0
        )
        const percRisco = calcularPorcentagem(
          countRisco,
          totalRespostasValidas,
          1
        )

        const countAtenuacao = atenuacaoLabels.reduce(
          (sum, label) => sum + (freq[label] || 0),
          0
        )
        const percAtenuacao = calcularPorcentagem(
          countAtenuacao,
          totalRespostasValidas,
          1
        )

        let riscoDesc = ''
        let atenuacaoDesc = ''

        if (
          colConfig.category === 'Demanda' ||
          colConfig.id.includes('repetir muitas vezes')
        ) {
          riscoDesc = 'frequentemente e √†s vezes'
          atenuacaoDesc = 'nunca ou quase nunca/raramente'
        } else if (colConfig.category === 'Controle') {
          riscoDesc = 'raramente e nunca ou quase nunca'
          atenuacaoDesc = 'frequentemente e √†s vezes'
        } else if (colConfig.category === 'Apoio Social') {
          riscoDesc = 'Discordo mais que concordo/Discordo totalmente'
          atenuacaoDesc = 'Concordo totalmente/Concordo mais que discordo'
        }

        let pontoDeAtencao = ''

        const nPercRisco = Number(percRisco)
        const nPercAtenuacao = Number(percAtenuacao)

        if (nPercRisco >= nPercAtenuacao) {
          pontoDeAtencao = `Predomin√¢ncia em **${questionTitle}** - **(${riscoDesc}) ${percRisco}%**, atenuado por **${percAtenuacao}%** que consideram **(${atenuacaoDesc})**.`
        } else {
          pontoDeAtencao = `Predomin√¢ncia em **${questionTitle}** - **(${atenuacaoDesc}) ${percAtenuacao}%**, atenuado por **${percRisco}%** que consideram **(${riscoDesc})**.`
        }

        return pontoDeAtencao
      }

      function gerarComentarioIndividual(
        colConfig,
        freq,
        totalRespostasValidas,
        index
      ) {
        let html = `<table class="chart-data-table" id="table-${index}"><thead><tr>`

        const tableHeaders = ['Resposta', 'Contagem (n)']
        html += tableHeaders.map((h) => `<th>${h}</th>`).join('')
        html += '</tr></thead><tbody>'

        colConfig.labels.forEach((label) => {
          const count = freq[label] || 0
          html += `<tr><td>${label}</td><td>${count}</td></tr>`
        })

        html += `<tr><td><b>Total</b></td><td><b>${totalRespostasValidas}</b></td></tr>`
        html += '</tbody></table>'

        return { html: html }
      }

      document
        .getElementById('btnGerar')
        .addEventListener('click', async () => {
          const chartsDiv = document.getElementById('charts')
          const commentaryDiv = document.getElementById('commentaryDiv')
          chartsDiv.innerHTML = ''
          commentaryDiv.innerHTML = ''
          document.getElementById('pdfReportContainer').innerHTML = ''
          chartObjects = []

          if (fullHeaders.length === 0 || excelData.length === 0) {
            alert('Carregue os dados do Excel primeiro.')
            return
          }

          const { commentary: commentsMap } =
            gerarComentarioGeralDetalhado(excelData)
          detailedCommentaries = commentsMap

          commentaryDiv.classList.add('hidden')

          let currentCategory = null

          JSS_COLUMNS.forEach((colConfig, index) => {
            const colId = colConfig.id
            const questionTitle = colConfig.header
            const category = colConfig.category

            const valores = excelData.map((r) => r[colId])
            const freq = contar(valores)

            if (Object.keys(freq).length === 0) return

            const labels = colConfig.labels
            const dataValues = labels.map((k) => freq[k] || 0)

            const totalRespostasValidas = dataValues.reduce((a, b) => a + b, 0)

            if (totalRespostasValidas === 0) return

            const maxData = Math.max(...dataValues)

            let dimensionHeaderHtml = ''

            if (category !== currentCategory) {
              currentCategory = category
              const dimensionTitle = DIMENSION_TITLES[category] || ''
              const dimensionDesc = DIMENSION_DESCRIPTIONS[category] || ''

              if (dimensionTitle) {
                const dimensionHeaderDiv = document.createElement('div')
                dimensionHeaderDiv.className = 'dimension-header'
                dimensionHeaderDiv.innerHTML = `${dimensionTitle}<span>${dimensionDesc}</span>`
                chartsDiv.appendChild(dimensionHeaderDiv)

                dimensionHeaderHtml = dimensionHeaderDiv.outerHTML
              }
            }

            const individualCommentary = gerarComentarioIndividual(
              colConfig,
              freq,
              totalRespostasValidas,
              index
            )

            const pontoAtencaoText = gerarPontoDeAtencao(
              colConfig,
              freq,
              totalRespostasValidas
            )

            // Captura o texto do plano de a√ß√£o
            const actionPlanText = colConfig.actionPlanText || ''

            // 1. Defini√ß√£o da vari√°vel
            const specificCommentText = detailedCommentaries[colId] || ''

            const container = document.createElement('div')
            container.className = 'chart-report-item-visual'
            container.id = `visual-item-${index}`
            container.style.display = 'flex'
            container.style.flexDirection = 'column'
            container.style.padding = '20px 0'
            container.style.borderBottom = '1px solid #eee'

            const htmlTitle = document.createElement('h4')
            htmlTitle.innerText = questionTitle

            const wrapper = document.createElement('div')
            wrapper.className = 'chart-wrapper'
            // AJUSTE: O wrapper de cada gr√°fico individual agora tem 300px de altura (do CSS)
            // LARGURA MANTIDA: 650px
            wrapper.style.width = '650px'

            const canvas = document.createElement('canvas')
            canvas.id = `chart-${index}`

            wrapper.appendChild(canvas)
            container.appendChild(htmlTitle)
            container.appendChild(wrapper)

            const dataTableDiv = document.createElement('div')
            dataTableDiv.innerHTML = individualCommentary.html
            container.appendChild(dataTableDiv)

            // 2. Coment√°rios Gerais (T√≠tulo em Azul)
            if (specificCommentText) {
              const specificCommentDiv = document.createElement('div')
              specificCommentDiv.className = 'commentary'
              specificCommentDiv.style.marginTop = '20px'
              specificCommentDiv.style.marginBottom = '15px'

              let commentBody = specificCommentText
                .split('\n')
                .slice(1)
                .join('<br>')
              commentBody = commentBody.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>')

              // T√≠tulo em AZUL
              specificCommentDiv.innerHTML = `<p style="font-weight: bold; margin-bottom: 5px; color: #2563eb;">${NEW_COMMENTARY_TITLE}</p>${commentBody}`
              container.appendChild(specificCommentDiv)
            }

            // Ponto de Aten√ß√£o (T√≠tulo em Laranja)
            if (pontoAtencaoText) {
              const pontoAtencaoDiv = document.createElement('div')
              pontoAtencaoDiv.className = 'attention-point'

              let formattedAttention = pontoAtencaoText.replace(
                /\*\*(.*?)\*\*/g,
                '<b>$1</b>'
              )

              // Adiciona o t√≠tulo Ponto de Aten√ß√£o com cor LARANJA
              pontoAtencaoDiv.innerHTML = `<p style="font-weight: bold; margin-bottom: 5px; color: #f97316;">${ATTENTION_POINT_TITLE}</p>${formattedAttention}`
              container.appendChild(pontoAtencaoDiv)
            }

            // Plano de A√ß√£o Proposto (T√≠tulo em Title Case e Verde)
            if (actionPlanText) {
              const actionPlanDiv = document.createElement('div')
              actionPlanDiv.className = 'action-plan-box'

              // T√≠tulo com primeira letra mai√∫scula e cor verde (mantida)
              actionPlanDiv.innerHTML = `<p style="font-weight: bold; margin-bottom: 5px; color: #047857;">${ACTION_PLAN_TITLE}</p>
                ${actionPlanText}`
              container.appendChild(actionPlanDiv)
            }

            chartsDiv.appendChild(container)

            const chart = new Chart(canvas, {
              type: 'bar',
              data: {
                labels: labels,
                datasets: [
                  {
                    label: 'Frequ√™ncia',
                    data: dataValues,
                    backgroundColor: '#3b82f6',
                    borderColor: '#2563eb',
                    borderWidth: 1,
                    barPercentage: 0.6
                  }
                ]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: false,
                scales: {
                  y: {
                    display: false,
                    beginAtZero: true,
                    suggestedMax: maxData + (maxData > 0 ? 1 : 1)
                  },
                  x: {
                    grid: { display: false },
                    ticks: {
                      maxRotation: 45,
                      minRotation: 0,
                      font: { size: 10 },
                      color: '#000' // AJUSTE: Cor do texto dos ticks para preto puro
                    }
                  }
                },
                layout: {
                  padding: { top: 25, bottom: 10, left: 10, right: 10 }
                },
                plugins: {
                  legend: { display: false },
                  title: { display: false },
                  datalabels: {
                    anchor: 'end',
                    align: 'top',
                    color: '#000', // J√° era preto, mantido para garantir
                    font: { weight: 'bold', size: 11 },
                    formatter: (value) => value
                  },
                  tooltip: { enabled: true }
                }
              }
            })

            // 3. Armazenamento da vari√°vel (CORRETO)
            chartObjects.push({
              title: questionTitle,
              chart: chart,
              chartId: `chart-${index}`,
              tableHtml: individualCommentary.html,
              specificCommentText: specificCommentText,
              pontoAtencaoText: pontoAtencaoText,
              dimensionHeaderHtml: dimensionHeaderHtml,
              // NOVO: Armazena o Plano de A√ß√£o
              actionPlanText: actionPlanText
            })
          })

          chartsDiv.style.display = 'block'
          chartsDiv.style.gridTemplateColumns = 'none'

          document.getElementById('graficosCard').classList.remove('hidden')

          // NOVO: Gerar e mostrar o Dashboard Final (Sem Karasek) na tela
          await gerarDashboardFinal()
          document
            .getElementById('dashboard-final-card')
            .classList.remove('hidden')
        })

      // ======================================================================
      // === FUN√á√ÉO PARA GERA√á√ÉO DO DASHBOARD FINAL (COM CORES PROFISSIONAIS E PERCENTUAL NA PIZZA) ===
      // ======================================================================

      async function gerarDashboardFinal() {
        // Limpa gr√°ficos anteriores
        finalCharts.forEach((c) => c.destroy())
        finalCharts = []

        const categorias = ['Demanda', 'Controle', 'Apoio Social']

        // 1. Processamento das Dimens√µes para os Gr√°ficos de Resumo (Pizza/Barra)
        categorias.forEach((cat) => {
          const isApoio = cat === 'Apoio Social'
          const labels = isApoio ? LABELS_APOIO_SOCIAL : LABELS_DEMANDA_CONTROLE
          const suffix = isApoio ? 'apoio' : cat.toLowerCase()

          const cols = JSS_COLUMNS.filter((c) => c.category === cat)

          let somaPorLabel = labels.map(() => 0)

          let dimensionColors

          // Define a paleta de cores consistente com a sem√¢ntica:
          // Risco Alto (#1e40af), Risco Moderado (#3b82f6), Fav. Moderado (#9ca3af), Fav. Alto (#d1d5db)

          if (cat === 'Demanda') {
            // Demanda: Risco √© 4 (Frequentemente).
            // Labels [1, 2, 3, 4] -> Cores [Fav. Alto, Fav. Mod., Risco Mod., Risco Alto]
            dimensionColors = ['#d1d5db', '#9ca3af', '#3b82f6', '#1e40af']
          } else if (cat === 'Controle' || cat === 'Apoio Social') {
            // Controle/Apoio: Risco √© 1 (Nunca/Discordo).
            // Labels [1, 2, 3, 4] -> Cores [Risco Alto, Risco Mod., Fav. Mod., Fav. Alto]
            dimensionColors = ['#1e40af', '#3b82f6', '#9ca3af', '#d1d5db']
          }

          let stackedDatasets = labels.map((l, i) => ({
            label: l,
            data: [],
            backgroundColor: dimensionColors[i], // Usa a cor sem√¢ntica correta
            // CORRE√á√ÉO: Removemos a borda branca aqui para evitar linhas brancas indesejadas
            borderWidth: 0,
            barPercentage: 0.6
          }))
          let shortLabels = []

          // Processa dados e calcula o total de respostas v√°lidas
          let totalRespostasDimensao = 0
          cols.forEach((col) => {
            const shortLabel = col.header.split(':')[0].trim() || 'Q'
            shortLabels.push(shortLabel)

            const vals = excelData.map((r) => r[col.id])
            const freq = contar(vals)
            const totalPergunta = labels
              .map((l) => freq[l] || 0)
              .reduce((a, b) => a + b, 0)

            totalRespostasDimensao += totalPergunta

            labels.forEach((label, idx) => {
              const qtd = freq[label] || 0
              somaPorLabel[idx] += qtd

              // Stacked Bar (%)
              const perc = totalPergunta > 0 ? (qtd / totalPergunta) * 100 : 0
              stackedDatasets[idx].data.push(perc)
            })
          })

          document.getElementById(`final-qty-${suffix}`).innerText =
            totalRespostasDimensao

          // GR√ÅFICO DE PIZZA - Prepara√ß√£o dos dados sem valores zero (CORRE√á√ÉO DA FATIA BRANCA)
          let pieLabels = []
          let pieData = []
          let pieColors = []

          somaPorLabel.forEach((val, idx) => {
            if (val > 0) {
              // FILTRO ESSENCIAL: Ignora valores zero
              pieLabels.push(labels[idx])
              pieData.push(val)
              pieColors.push(dimensionColors[idx])
            }
          })

          if (pieData.length === 0 && totalRespostasDimensao > 0) {
            // Caso todos os dados somados sejam 0 (dados inv√°lidos)
            // Se isso acontecer, ele mostrar√° um gr√°fico vazio, mas a fatia branca deve ter desaparecido.
          }

          // CRIA√á√ÉO DO GR√ÅFICO DE PIZZA
          const ctxPie = document
            .getElementById(`final-pie-${suffix}`)
            .getContext('2d')
          // Se o gr√°fico existir, destr√≥i antes de criar
          if (finalCharts.some((c) => c.canvas.id === ctxPie.canvas.id)) {
            finalCharts.find((c) => c.canvas.id === ctxPie.canvas.id).destroy()
          }

          const pie = new Chart(ctxPie, {
            type: 'pie',
            data: {
              labels: pieLabels,
              datasets: [
                {
                  data: pieData,
                  backgroundColor: pieColors, // Cores sem√¢nticas aplicadas
                  // CORRE√á√ÉO ESSENCIAL: Garante que a borda √© 0
                  borderWidth: 0
                  // CORRE√á√ÉO DA FAIXA BRANCA: Removida a linha 'borderColor' para evitar artefatos
                }
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              // AJUSTE PARA O TAMANHO DA PIZZA
              layout: { padding: -10 },
              plugins: {
                legend: {
                  // CORRIGIDO: Legenda for√ßada para o topo
                  position: 'top',
                  labels: {
                    boxWidth: 12,
                    font: {
                      size: 14
                    } /* NOVO AJUSTE: Aumentado de 12 para 14 */,
                    color: '#000' // AJUSTE: Cor do texto da legenda para preto puro
                  }
                },
                // CORRE√á√ÉO: datalabels para exibir o percentual
                datalabels: {
                  color: '#fff', // Cor da fonte (branco)
                  font: {
                    weight: 'bold',
                    size: 14
                  } /* NOVO AJUSTE: Aumentado de 12 para 14 */,
                  // Aumento do blur da sombra para garantir melhor captura no PDF
                  textShadow: { color: 'rgba(0,0,0,1)', blur: 4 },
                  formatter: (val, ctx) => {
                    // O sum deve ser calculado com base APENAS nos dados exibidos
                    let sum = pieData.reduce((a, b) => a + b, 0)
                    if (sum === 0) return ''
                    // NOVO AJUSTE: N√£o exibe label para fatias muito pequenas (<= 2%)
                    if (val / sum < 0.02) return ''
                    return ((val / sum) * 100).toFixed(1) + '%'
                  }
                }
              }
            }
          })
          finalCharts.push(pie)

          // GR√ÅFICO DE BARRAS EMPILHADAS
          const ctxBar = document
            .getElementById(`final-bar-${suffix}`)
            .getContext('2d')

          // Se o gr√°fico existir, destr√≥i antes de criar
          if (finalCharts.some((c) => c.canvas.id === ctxBar.canvas.id)) {
            finalCharts.find((c) => c.canvas.id === ctxBar.canvas.id).destroy()
          }

          const bar = new Chart(ctxBar, {
            type: 'bar',
            data: { labels: shortLabels, datasets: stackedDatasets },
            options: {
              indexAxis: 'y',
              responsive: true,
              maintainAspectRatio: false,
              layout: { padding: { top: 10, right: 20 } },
              scales: {
                x: {
                  stacked: true,
                  min: 0,
                  max: 100,
                  ticks: {
                    callback: (v) => v + '%',
                    font: { size: 14 },
                    color: '#000' // AJUSTE: Cor do texto dos ticks para preto puro
                  } /* NOVO AJUSTE: Aumentado de 12 para 14 */,
                  grid: { display: true }
                },
                y: {
                  stacked: true,
                  grid: { display: false },
                  ticks: {
                    font: { size: 14 },
                    color: '#000' // AJUSTE: Cor do texto dos ticks para preto puro
                  } /* NOVO AJUSTE: Aumentado de 12 para 14 */
                }
              },
              plugins: {
                // HABILITA A LEGENDA
                legend: {
                  display: true,
                  position: 'bottom',
                  labels: {
                    boxWidth: 12,
                    font: {
                      size: 13
                    } /* NOVO AJUSTE: Aumentado de 11 para 13 */
                  }
                },
                // CORRE√á√ÉO: datalabels para mostrar percentual dentro da barra
                datalabels: {
                  // NOVO: L√≥gica de cor para legibilidade (claro no escuro / escuro no claro)
                  color: (ctx) => {
                    const color = dimensionColors[ctx.datasetIndex]
                    if (color === '#1e40af' || color === '#3b82f6') {
                      return '#fff' // Retorna branco para fundo escuro
                    }
                    return '#000' // AJUSTE: Era #333 (cinza escuro), agora √© #000 (preto puro)
                  },
                  font: {
                    size: 13,
                    weight: 'bold'
                  } /* NOVO AJUSTE: Aumentado de 11 para 13 */,
                  // CORRE√á√ÉO: Mostra apenas se o valor for >= 5%
                  formatter: (v) => (v >= 5 ? Math.round(v) + '%' : '')
                }
              }
            }
          })
          finalCharts.push(bar)
        })
      }

      // ======================================================================
      // === FUN√á√ïES PDF ===
      // ======================================================================

      function addReferenceBox(doc, pageMargin, pageH) {
        // ... (Corpo da fun√ß√£o de Refer√™ncia)
        const refText = [
          'JSS - JOB STRESS SCALE [ESCALA DE ESTRESSE NO TRABALHO]',
          'Refer√™ncias: Alves MGM, Chor D, Faerstein E, Lopes CS, Wemeck GL. Vers√£o resumida da "Job Stress Scale": adapta√ß√£o para portugu√™s.',
          'Rev. Sa√∫de P√∫blica. 2004. Karasek RA. Theorell T. Healthy work-stress. productivity, and the reconstruction of working life. New York: Basic Books: 1990.'
        ]

        const BOX_WIDTH_MM = 190
        const BOX_HEIGHT_MM = 15
        const BORDER_COLOR = 150
        const TEXT_COLOR = 50
        const FONT_SIZE = 7
        const LINE_SPACING = 3.5

        const BOX_X_MM = (doc.internal.pageSize.getWidth() - BOX_WIDTH_MM) / 2
        const BOX_Y_MM = pageH - pageMargin - BOX_HEIGHT_MM

        doc.setDrawColor(BORDER_COLOR)
        doc.setLineWidth(0.2)
        doc.rect(BOX_X_MM, BOX_Y_MM, BOX_WIDTH_MM, BOX_HEIGHT_MM)

        doc.setFont('helvetica', 'normal')
        doc.setFontSize(FONT_SIZE)
        doc.setTextColor(TEXT_COLOR)

        let currentY = BOX_Y_MM + 3

        refText.forEach((line) => {
          const lines = doc.splitTextToSize(line, BOX_WIDTH_MM - 4)
          doc.text(lines, BOX_X_MM + 2, currentY)
          currentY += lines.length * LINE_SPACING
        })

        doc.setFillColor(255, 255, 255)
        doc.setDrawColor(0, 0, 0)
      }

      function addHeaderFooter(doc, pageNumber, totalPages) {
        // ... (Corpo da fun√ß√£o Header/Footer)
        const HEADER_HEIGHT_MM = 15
        const FOOTER_HEIGHT_MM = 15
        const PAGE_MARGIN_MM = 10
        const PAGE_WIDTH_MM = doc.internal.pageSize.getWidth()
        const PAGE_HEIGHT_MM = doc.internal.pageSize.getHeight()

        doc.setFont('helvetica', 'bold')
        doc.setFontSize(10)
        doc.setTextColor(37, 99, 235) // Corrigida para azul
        doc.text(
          'Relat√≥rio de An√°lise - Job Stress Scale',
          PAGE_MARGIN_MM,
          HEADER_HEIGHT_MM - 5
        )

        doc.setFont('helvetica', 'normal')
        doc.setFontSize(8)
        doc.setTextColor(100, 100, 100)

        const pageText = `P√°gina ${pageNumber} de ${totalPages}`

        doc.text(
          pageText,
          PAGE_WIDTH_MM - PAGE_MARGIN_MM,
          HEADER_HEIGHT_MM - 5,
          { align: 'right' }
        )

        doc.setDrawColor(200, 200, 200)
        doc.line(
          PAGE_MARGIN_MM,
          HEADER_HEIGHT_MM,
          PAGE_WIDTH_MM - PAGE_MARGIN_MM,
          HEADER_HEIGHT_MM
        )

        doc.setDrawColor(200, 200, 200)
        doc.line(
          PAGE_MARGIN_MM,
          PAGE_HEIGHT_MM - FOOTER_HEIGHT_MM,
          PAGE_WIDTH_MM - PAGE_MARGIN_MM,
          PAGE_HEIGHT_MM - FOOTER_HEIGHT_MM
        )

        const signatureLines = [
          'Engenheiro de Seguran√ßa do Trabalho',
          'Rog√©rio Luiz Mota de Oliveira',
          'CREA RNP: 180630565-8 - PE 39325D'
        ]

        doc.setFont('helvetica', 'normal')
        doc.setFontSize(8)
        doc.setTextColor(50, 50, 50)

        // AJUSTE: Movido de +12 para +8 para subir o texto do rodap√©
        let textY = PAGE_HEIGHT_MM - FOOTER_HEIGHT_MM + 11

        for (let i = signatureLines.length - 1; i >= 0; i--) {
          const line = signatureLines[i]

          doc.text(line, PAGE_WIDTH_MM - PAGE_MARGIN_MM, textY, {
            align: 'right'
          })

          textY -= 3.5
        }
      }

      // ======================================================================
      // === EXPORTAR PDF (CONSOLIDADO E CORRIGIDO) ===
      // ======================================================================
      document.getElementById('btnPDF').addEventListener('click', async () => {
        if (chartObjects.length === 0) {
          alert('Gere os gr√°ficos primeiro.')
          return
        }

        const btn = document.getElementById('btnPDF')
        const oldTxt = btn.innerText
        btn.innerText = 'Gerando PDF...'
        btn.disabled = true

        const PAGE_MARGIN_MM = 10
        const COVER_PAGE_MARGIN_MM = 15
        const HEADER_HEIGHT_MM = 15
        const FOOTER_HEIGHT_MM = 15

        // Total de p√°ginas: Capa (1) + Explica√ß√£o (1) + Gr√°ficos (n) + Dashboard Final (1)
        // O n√∫mero de p√°ginas de gr√°ficos √© determinado dinamicamente, mas a contagem de p√°ginas totais √© est√°tica
        const TOTAL_PAGES = chartObjects.length + 2 // Capa + Explica√ß√£o + Dashboard = 3 p√°ginas fixas + N p√°ginas de gr√°ficos

        const doc = new jsPDF('p', 'mm', 'a4')

        // Tamanhos da p√°gina A4 em Mil√≠metros (padr√£o)
        const PAGE_WIDTH_PORTRAIT = doc.internal.pageSize.getWidth() // 210
        const PAGE_HEIGHT_PORTRAIT = doc.internal.pageSize.getHeight() // 297

        const PORTRAIT_CONTENT_WIDTH =
          PAGE_WIDTH_PORTRAIT - COVER_PAGE_MARGIN_MM * 2 // 180mm

        // Hardcoded Landscape A4 dimensions (297x210)
        const PAGE_WIDTH_LANDSCAPE = 297
        const PAGE_HEIGHT_LANDSCAPE = 208

        // Larguras e Limites para o formato LANDSCAPE (Gr√°ficos)
        const CONTENT_WIDTH_LANDSCAPE =
          PAGE_WIDTH_LANDSCAPE - PAGE_MARGIN_MM * 2 // 277mm
        const PAGE_BREAK_LIMIT_LANDSCAPE =
          PAGE_HEIGHT_LANDSCAPE - FOOTER_HEIGHT_MM // Altura A4 Paisagem
        const CONTAINER_WIDTH_PX_LANDSCAPE = 880 // Largura do container para captura (em pixels)
        // **NOVO AJUSTE DE TAMANHO**: Reduzido de 230mm para 215mm para garantir que o bloco caiba no rodap√©
        const CHART_IMG_WIDTH_MM = 215

        // -----------------------------------------------------------
        // P√ÅGINA DE ROSTO (CAPA) - P√ÅGINA 1 (PORTRAIT)
        // -----------------------------------------------------------
        const currentDate = new Date().toLocaleDateString('pt-BR')
        let cursorY = PAGE_HEIGHT_PORTRAIT / 2 - 40

        doc.setFillColor(248, 248, 248)
        doc.rect(0, 0, PAGE_WIDTH_PORTRAIT, PAGE_HEIGHT_PORTRAIT, 'F')
        doc.setFillColor(255, 255, 255)
        doc.setDrawColor(0, 0, 0)

        doc.setFont('helvetica', 'bold')
        doc.setFontSize(24)
        doc.setTextColor(30, 30, 30)
        doc.text(companyName, PAGE_WIDTH_PORTRAIT / 2, cursorY, {
          align: 'center'
        })
        cursorY += 15

        doc.setDrawColor(37, 99, 235)
        doc.setLineWidth(1.5)
        doc.line(
          PAGE_WIDTH_PORTRAIT / 2 - 50,
          cursorY,
          PAGE_WIDTH_PORTRAIT / 2 + 50,
          cursorY
        )
        cursorY += 15

        doc.setFont('helvetica', 'bold')
        doc.setFontSize(28)
        doc.setTextColor(37, 99, 235)
        doc.text('JSS - Job Stress Scale', PAGE_WIDTH_PORTRAIT / 2, cursorY, {
          align: 'center'
        })
        cursorY += 15

        doc.setFont('helvetica', 'normal')
        doc.setFontSize(14)
        doc.setTextColor(0, 0, 0)

        const subtitleLines = doc.splitTextToSize(
          'INVENT√ÅRIO DE RISCOS/PERIGOS PSICOSSOCIAIS RELACIONADOS AO TRABALHO - NR 01',
          PORTRAIT_CONTENT_WIDTH // VARI√ÅVEL AGORA DEFINIDA CORRETAMENTE
        )
        doc.text(subtitleLines, PAGE_WIDTH_PORTRAIT / 2, cursorY, {
          align: 'center'
        })
        cursorY += subtitleLines.length * 8

        cursorY += 15
        doc.setFont('helvetica', 'bold')
        doc.setFontSize(14)
        doc.setTextColor(37, 99, 235)

        doc.text(currentDate, PAGE_WIDTH_PORTRAIT / 2, cursorY, {
          align: 'center'
        })

        addReferenceBox(doc, COVER_PAGE_MARGIN_MM, PAGE_HEIGHT_PORTRAIT)

        // -----------------------------------------------------------
        // P√ÅGINA EXPLICATIVA - P√ÅGINA 2 (PORTRAIT)
        // -----------------------------------------------------------
        doc.addPage('a4', 'p')
        addHeaderFooter(doc, 2, TOTAL_PAGES)

        const explanatoryText_Word = {
          title: 'MODELO DE "JOB STRESS SCALE"',
          paragraphs: [
            'A avalia√ß√£o dos aspectos relacionados √† dimens√£o psicossocial do trabalho e sa√∫de mental vem ganhando relevante aten√ß√£o nos estudos em Sa√∫de e trabalho. A Norma Regulamentadora 01 (NR-01) ‚Äì Disposi√ß√µes Gerais e Gerenciamento de Riscos Ocupacionais determina que o gerenciamento de riscos ocupacionais deve abranger riscos relacionados aos fatores ergon√¥micos, incluindo os fatores de risco psicossociais relacionados ao trabalho.',
            'Diante da aus√™ncia formal de indica√ß√£o do Minist√©rio do Trabalho de ferramentas ou instrumentos t√©cnico-cient√≠ficos para inventariar os Riscos/Perigos Psicossociais na NR01, fica a crit√©rio das empresas a escolha do mecanismo que materialize o diagnostico e a√ß√µes que devem compor tal inventario, bem como o Plano de A√ß√£o requerido no PGR.',
            'Desta forma, a Produtiva Sa√∫de e Seguran√ßa Ocupacional, ap√≥s a avalia√ß√£o de diversas ferramentas presentes na Literatura T√©cnica internacional com a devida valida√ß√£o cient√≠fica, escolheu o ‚ÄúModelo Job Stress Scale‚Äù elaborado por T√∂res Theorell (1988), pois tornou-se modelo de refer√™ncia mundial, contendo 17 quest√µes: cinco para avaliar demanda, seis para avaliar controle e seis para apoio social.',
            'Para as dimens√µes que avaliam demanda e controle, as op√ß√µes de resposta s√£o apresentadas em escala tipo likert (1-4), variando entre ‚Äúfrequentemente‚Äù e ‚Äúnuca/quase nunca‚Äù. Quanto ao bloco referente ao apoio social, as op√ß√µes de resposta, tamb√©m em escala likert, possuem varia√ß√£o entre ‚Äúconcordo totalmente‚Äù e ‚Äúdiscordo totalmente‚Äù.',
            'As tr√™s dimens√µes refletem componentes essenciais da sa√∫de mental ocupacional e permitem compreender o impacto psicossocial do ambiente de trabalho sobre o bem-estar do indiv√≠duo.'
          ],
          dimensions: [
            {
              dimensao: 'Demanda Psicol√≥gica',
              descricao:
                'Grau de exig√™ncia do trabalho (ritmo, intensidade, conflitos de tarefa, ass√©dio)',
              interpretacao: 'Escores altos indicam maior press√£o no trabalho.'
            },
            {
              dimensao: 'Controle sobre o Trabalho',
              descricao:
                'Autonomia e uso de habilidades cognitivas, incluindo discernimento intelectual e autoridade decis√≥ria.',
              interpretacao:
                'Escores altos refletem autonomia; baixos indicam vulnerabilidade.'
            },
            {
              dimensao: 'Apoio Social',
              descricao:
                'Qualidade das rela√ß√µes interpessoais com colegas e supervisores.',
              interpretacao:
                'Escores altos refletem suporte; baixo indicam risco de isolamento.'
            }
          ],
          scores: [
            { dimensao: 'Demanda', itens: '1 ‚Äì 5', min: '5', max: '20' },
            { dimensao: 'Controle', itens: '6 ‚Äì 11', min: '6', max: '24' },
            { dimensao: 'Apoio Social', itens: '12 - 17', min: '6', max: '24' }
          ],
          perfis: [
            {
              perfil: 'Alto Desgaste',
              caracteristicas:
                'Alta demanda e baixo controle ‚Äì maior risco de adoecimento.'
            },
            {
              perfil: 'Trabalho Ativo',
              caracteristicas:
                'Alta demanda e alto controle ‚Äì maior engajamento e crescimento.'
            },
            {
              perfil: 'Trabalho Passivo',
              caracteristicas:
                'Baixa demanda e baixo controle - apatia e desmotiva√ß√£o.'
            },
            {
              perfil: 'Baixo Desgaste',
              caracteristicas:
                'Baixa demanda e alto controle ‚Äì equil√≠brio e bem-estar.'
            }
          ],
          apoioSocialFinal:
            'O Apoio Social funciona como atenuador/moderador no resultado da intera√ß√£o entre demanda e controle, objetivando o qu√£o maior possa ser esta dimens√£o, contrabalanceando com as demais dimens√µes. Quando altas demandas e alto controle coexistem, ainda que as demandas sejam excessivas, elas s√£o menos danosas, na medida em que o trabalhador pode escolher como planejar suas horas de trabalho de acordo com suas necessidades.'
        }

        let currentYExplanatory = HEADER_HEIGHT_MM + 5 + 5
        const PORTRAIT_CONTENT_WIDTH_TEXT_AUTO =
          PAGE_WIDTH_PORTRAIT - PAGE_MARGIN_MM * 2 // 190mm

        // T√≠tulo
        doc.setFont('helvetica', 'bold')
        doc.setFontSize(16)
        doc.setTextColor(37, 99, 235)
        doc.text(
          explanatoryText_Word.title,
          PAGE_WIDTH_PORTRAIT / 2,
          currentYExplanatory,
          {
            align: 'center'
          }
        )
        // AJUSTE 1: Redu√ß√£o do espa√ßamento ap√≥s o t√≠tulo principal (15 -> 10)
        currentYExplanatory += 10

        doc.setFont('helvetica', 'normal')
        doc.setFontSize(10)
        doc.setTextColor(0, 0, 0)

        // Par√°grafos de Introdu√ß√£o
        explanatoryText_Word.paragraphs.forEach((paragraph) => {
          const lines = doc.splitTextToSize(
            paragraph,
            PORTRAIT_CONTENT_WIDTH_TEXT_AUTO - 20
          )
          doc.text(lines, PAGE_MARGIN_MM + 10, currentYExplanatory, {
            align: 'justify',
            maxWidth: PORTRAIT_CONTENT_WIDTH_TEXT_AUTO - 20
          })
          // AJUSTE 2: Redu√ß√£o da linha e margem dos par√°grafos (4.5 + 5 -> 4 + 4)
          currentYExplanatory += lines.length * 4 + 4
        })

        // T√≠tulo Tabela 1: Dimens√µes
        doc.setFont('helvetica', 'bold')
        doc.setFontSize(11)
        doc.setTextColor(30, 30, 30)
        doc.text(
          'Tabela 1: Dimens√µes, Descri√ß√£o e Interpreta√ß√£o',
          PAGE_WIDTH_PORTRAIT / 2,
          currentYExplanatory,
          { align: 'center' }
        )
        currentYExplanatory += 5

        // Tabela 1 - Dimens√µes
        doc.autoTable({
          startY: currentYExplanatory,
          head: [['Dimens√£o', 'Descri√ß√£o', 'Interpretacao']],
          body: explanatoryText_Word.dimensions.map((d) => [
            d.dimensao,
            d.descricao,
            d.interpretacao
          ]),
          theme: 'grid',
          styles: { fontSize: 8, cellPadding: 1, overflow: 'linebreak' },
          headStyles: {
            fillColor: [230, 230, 230],
            textColor: [0, 0, 0],
            fontStyle: 'bold'
          },
          columnStyles: {
            0: { cellWidth: 35 },
            1: { cellWidth: 75 },
            2: { cellWidth: 80 }
          },
          margin: { left: PAGE_MARGIN_MM }
        })
        // AJUSTE 3: Redu√ß√£o da margem ap√≥s a Tabela 1 (8 -> 6)
        currentYExplanatory = doc.lastAutoTable.finalY + 6

        // T√≠tulo Tabela 2: Escores
        doc.setFont('helvetica', 'bold')
        doc.setFontSize(11)
        doc.text(
          'Tabela 2: Escores M√≠nimo e M√°ximo por Dimens√£o',
          PAGE_WIDTH_PORTRAIT / 2,
          currentYExplanatory,
          { align: 'center' }
        )
        currentYExplanatory += 5

        // Tabela 2 - Escores
        doc.autoTable({
          startY: currentYExplanatory,
          head: [['Dimens√£o', 'Itens', 'Escore M√≠nimo', 'Escore M√°ximo']],
          body: explanatoryText_Word.scores.map((s) => [
            s.dimensao,
            s.itens,
            s.min,
            s.max
          ]),
          theme: 'grid',
          styles: { fontSize: 8, cellPadding: 1, halign: 'center' },
          headStyles: {
            fillColor: [230, 230, 230],
            textColor: [0, 0, 0],
            fontStyle: 'bold'
          },
          margin: { left: (PAGE_WIDTH_PORTRAIT - 100) / 2 }, // Centralizar
          columnStyles: {
            0: { cellWidth: 30 },
            1: { cellWidth: 20 },
            2: { cellWidth: 25 },
            3: { cellWidth: 25 }
          }
        })
        // AJUSTE 4: Redu√ß√£o da margem ap√≥s a Tabela 2 (8 -> 6)
        currentYExplanatory = doc.lastAutoTable.finalY + 6

        // T√≠tulo Tabela 3: Perfis Ocupacionais
        doc.setFont('helvetica', 'bold')
        doc.setFontSize(11)
        doc.text(
          'Tabela 3: Perfis Ocupacionais Baseados em Demanda e Controle',
          PAGE_WIDTH_PORTRAIT / 2,
          currentYExplanatory,
          { align: 'center' }
        )
        currentYExplanatory += 5

        // Tabela 3 - Perfis
        doc.autoTable({
          startY: currentYExplanatory,
          head: [['Perfil Ocupacional', 'Principais Caracter√≠sticas']],
          body: explanatoryText_Word.perfis.map((p) => [
            p.perfil,
            p.caracteristicas
          ]),
          theme: 'grid',
          styles: { fontSize: 8, cellPadding: 1, overflow: 'linebreak' },
          headStyles: {
            fillColor: [230, 230, 230],
            textColor: [0, 0, 0],
            fontStyle: 'bold'
          },
          columnStyles: {
            0: { cellWidth: 50 },
            1: { cellWidth: 140 }
          },
          margin: { left: PAGE_MARGIN_MM }
        })
        // AJUSTE 5: Redu√ß√£o da margem ap√≥s a Tabela 3 (8 -> 6)
        currentYExplanatory = doc.lastAutoTable.finalY + 6

        // Texto Final sobre Apoio Social
        doc.setFont('helvetica', 'normal')
        doc.setFontSize(10)
        doc.text(
          'Conclus√£o sobre Apoio Social:',
          PAGE_MARGIN_MM,
          currentYExplanatory
        )
        // AJUSTE 6: Redu√ß√£o do espa√ßamento ap√≥s o t√≠tulo de conclus√£o (5 -> 4)
        currentYExplanatory += 4
        const linesApoio = doc.splitTextToSize(
          explanatoryText_Word.apoioSocialFinal,
          PORTRAIT_CONTENT_WIDTH_TEXT_AUTO - 20
        )
        doc.text(linesApoio, PAGE_MARGIN_MM + 10, currentYExplanatory, {
          align: 'justify',
          maxWidth: PORTRAIT_CONTENT_WIDTH_TEXT_AUTO - 20
        })

        // -----------------------------------------------------------
        // GR√ÅFICOS INDIVIDUAIS - P√ÅGINA 3 em diante (TODAS LANDSCAPE)
        // -----------------------------------------------------------

        // **REMO√á√ÉO DA LINHA ABAIXO:** doc.addPage('a4', 'l') foi removida.
        // O loop agora adicionar√° a primeira p√°gina do gr√°fico (P√°g 3) com 'l' apenas se o primeiro gr√°fico n√£o couber na P√°g 2,
        // mas como come√ßamos o loop adicionando a primeira p√°gina, usaremos doc.addPage('a4', 'l') antes de come√ßar a adicionar gr√°ficos.

        const pdfContainer = document.getElementById('pdfReportContainer')
        pdfContainer.innerHTML = ''

        // Inicializa o container com a largura para PAISAGEM (880px)
        pdfContainer.style.width = CONTAINER_WIDTH_PX_LANDSCAPE + 'px' // 880px

        let pageIndexCounter = 3 // Come√ßamos na P√°gina 3
        let currentY = HEADER_HEIGHT_MM + 5
        addHeaderFooter(doc, pageIndexCounter, TOTAL_PAGES)

        for (let i = 0; i < chartObjects.length; i++) {
          const item = chartObjects[i]

          // Define o limite e a largura do conte√∫do, AGORA SEMPRE PARA LANDSCAPE
          let currentLimit = PAGE_BREAK_LIMIT_LANDSCAPE
          // NOVO AJUSTE: Usa a largura reduzida (215mm)
          let imgWidthInMM = CHART_IMG_WIDTH_MM

          // Monta o item do relat√≥rio (HTML)
          const itemWrapper = document.createElement('div')
          itemWrapper.className = 'pdf-report-item'

          if (item.dimensionHeaderHtml) {
            itemWrapper.innerHTML += item.dimensionHeaderHtml
          }
          itemWrapper.innerHTML += `<h2>${item.title}</h2>`
          const chartCanvas = document.getElementById(item.chartId)

          if (chartCanvas) {
            try {
              const chartImg = chartCanvas.toDataURL('image/png', 1.0)
              // Width: 630px para caber nos 880px do container de captura em paisagem
              itemWrapper.innerHTML += `<img src="${chartImg}" style="width: 630px; height: 260px; display: block; margin: 0 auto 10px auto; border: 1px solid #ccc;">`
            } catch (e) {
              itemWrapper.innerHTML += `<p style="color: red; text-align: center;">[ERRO ao carregar imagem do gr√°fico]</p>`
            }
          }

          itemWrapper.innerHTML += item.tableHtml

          // Coment√°rios Gerais (T√≠tulo em Azul)
          if (item.specificCommentText) {
            let commentBody = item.specificCommentText
              .split('\n')
              .slice(1)
              .join('<br>')
            commentBody = commentBody.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>')

            itemWrapper.innerHTML += `<p style="font-weight: bold; margin-top: 20px; font-size: 11px; color: #2563eb;">${NEW_COMMENTARY_TITLE}</p>`
            itemWrapper.innerHTML += `<div class="commentary" style="white-space: normal;">${commentBody}</div>`
          }

          // Ponto de Aten√ß√£o (T√≠tulo em Laranja)
          if (item.pontoAtencaoText) {
            let formattedAttention = item.pontoAtencaoText.replace(
              /\*\*(.*?)\*\*/g,
              '<b>$1</b>'
            )
            itemWrapper.innerHTML += `<p style="font-weight: bold; margin-top: 20px; font-size: 11px; color: #f97316;">${ATTENTION_POINT_TITLE}</p>`
            itemWrapper.innerHTML += `<div class="attention-point" style="white-space: normal;">${formattedAttention}</div>`
          }

          // Plano de A√ß√£o (T√≠tulo em Title Case e Verde)
          if (item.actionPlanText) {
            itemWrapper.innerHTML += `<p style="font-weight: bold; margin-top: 20px; font-size: 11px; color: #047857;">${ACTION_PLAN_TITLE}</p>`
            itemWrapper.innerHTML += `<div class="action-plan-box" style="white-space: normal;">${item.actionPlanText}</div>`
          }

          pdfContainer.appendChild(itemWrapper)

          // Captura a altura necess√°ria em MM (aproximadamente, para o check de quebra)
          await new Promise((resolve) => setTimeout(resolve, 50)) // Pequeno delay
          const requiredHeight = itemWrapper.offsetHeight / 3.78 // Convers√£o para mm

          // O ponto CR√çTICO: Checagem de quebra de p√°gina
          if (currentY + requiredHeight > currentLimit) {
            // Se for quebrar, limpa o container e re-adiciona o item (para que ele seja o primeiro na pr√≥xima p√°gina)
            pdfContainer.innerHTML = ''
            pdfContainer.appendChild(itemWrapper)

            pageIndexCounter++

            // Adiciona nova p√°gina, MANTENDO Landscape
            doc.addPage('a4', 'l')

            // Ajusta a largura do container (j√° est√°, mas garante)
            pdfContainer.style.width = CONTAINER_WIDTH_PX_LANDSCAPE + 'px'

            currentY = HEADER_HEIGHT_MM + 5 // Reseta Y
            addHeaderFooter(doc, pageIndexCounter, TOTAL_PAGES)
          }

          // Captura o container vis√≠vel com ESCALA 5
          const canvas = await html2canvas(itemWrapper, {
            scale: 5,
            useCORS: true,
            logging: false,
            width: pdfContainer.offsetWidth,
            height: itemWrapper.offsetHeight
          })

          const imgData = canvas.toDataURL('image/jpeg', 0.9)
          const imgWidth = imgWidthInMM // **USANDO A LARGURA REDUZIDA EM MM (215mm)**
          const imgHeightProportional =
            (canvas.height * imgWidth) / canvas.width
          let finalImgHeight = Math.min(
            imgHeightProportional,
            currentLimit - currentY // Garante que n√£o ultrapasse a margem do rodap√©
          )

          // Posi√ß√£o X (Centraliza a imagem de 215mm)
          const X_START = (doc.internal.pageSize.getWidth() - imgWidth) / 2

          doc.addImage(
            imgData,
            'JPEG',
            X_START,
            currentY,
            imgWidth,
            finalImgHeight,
            null,
            'FAST'
          )

          // Atualiza a posi√ß√£o Y para o pr√≥ximo gr√°fico
          currentY += finalImgHeight + 5 // 5mm de margem entre gr√°ficos

          // Limpa o container para o pr√≥ximo gr√°fico (se houver)
          pdfContainer.innerHTML = ''
        }

        // -----------------------------------------------------------
        // DASHBOARD FINAL (DISTRIBUI√á√ÉO) - √öLTIMA P√ÅGINA (LANDSCAPE)
        // -----------------------------------------------------------

        // 1. Garante que os gr√°ficos foram gerados e est√£o no DOM vis√≠vel
        await gerarDashboardFinal()

        // CR√çTICO: Garante que o container esteja na largura correta para Paisagem (L)
        pdfContainer.style.width = CONTAINER_WIDTH_PX_LANDSCAPE + 'px' // 880px

        // AJUSTE PARA FAIXA BRANCA: Aumenta o atraso de captura para 1000ms
        await new Promise((resolve) => setTimeout(resolve, 1000))

        // 2. Captura o container VIS√çVEL do Dashboard com ESCALA 6
        const dashContainerVisible = document.getElementById(
          'dashboard-final-container'
        )

        // Adiciona uma nova p√°gina Paisagem
        doc.addPage('a4', 'l') // CR√çTICO: LANDSCAPE ('l')
        const finalPageNumber = TOTAL_PAGES
        addHeaderFooter(doc, finalPageNumber, TOTAL_PAGES)

        const canvasDash = await html2canvas(dashContainerVisible, {
          scale: 3,
          useCORS: true,
          logging: false
        })

        const imgDash = canvasDash.toDataURL('image/png', 0.3)

        // Ajusta a imagem na p√°gina A4 Paisagem (297 x 210 mm)
        const pdfW = CONTENT_WIDTH_LANDSCAPE - 20 // 257mm (Mantido mais largo para o dashboard)
        const pdfH_proportional = (canvasDash.height * pdfW) / canvasDash.width
        const Y_START = HEADER_HEIGHT_MM + 5

        const MAX_HEIGHT =
          PAGE_HEIGHT_LANDSCAPE - HEADER_HEIGHT_MM - FOOTER_HEIGHT_MM - 5

        let finalPdfH = Math.min(pdfH_proportional, MAX_HEIGHT)
        let finalX = (PAGE_WIDTH_LANDSCAPE - pdfW) / 2 // Centraliza

        doc.addImage(
          imgDash,
          'JPEG',
          finalX,
          Y_START,
          pdfW,
          finalPdfH,
          null,
          'FAST'
        )

        // Salva
        const fileName = `Relatorio_JSS_Misto_${companyName}_vFinal.pdf`
        doc.save(fileName)

        // Ocultar container e reativar bot√£o
        pdfContainer.style.left = '-9999px'
        pdfContainer.style.top = '-9999px'

        btn.innerText = oldTxt
        btn.disabled = false
      })
    </script>
  </body>
</html>
